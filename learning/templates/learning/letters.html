{% extends 'learning/base.html' %}

{% block title %}H·ªçc Ch·ªØ C√°i - ASL Learning{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="row mb-3">
        <div class="col text-center">
            <h3 class="fw-bold mb-2">H·ªçc B·∫£ng Ch·ªØ C√°i ASL</h3>
            <p class="text-muted" style="font-size: 0.9rem;">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong phi√™n b·∫£n ti·∫øp theo</p>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="row">
                <!-- Left: Reference Image -->
                <div class="col-md-6 mb-3">
                    <div id="letter-card-container" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Camera Feed -->
                <div class="col-md-6 mb-3">
                    <div class="card shadow-lg rounded-3" style="height: 468px; overflow: hidden;">
                        <div class="card-body p-0 position-relative" style="height: 400px;">
                            <video id="video" autoplay playsinline class="w-100 h-100" style="object-fit: cover; background: #000; transform: scaleX(-1);"></video>
                            <canvas id="canvas" style="display:none;"></canvas>
                            
                            <!-- Success indicator -->
                            <div id="success-indicator" class="position-absolute top-50 start-50 translate-middle" style="display:none;">
                                <i class="fas fa-check-circle text-success" style="font-size: 100px; opacity: 0.9;"></i>
                            </div>
                        </div>
                        <div class="card-footer text-center bg-white" style="height: 68px;">
                            <button id="btn-camera" class="btn btn-primary btn-sm">
                                <i class="fas fa-camera me-1"></i>B·∫≠t Camera
                            </button>
                            <div id="camera-status" class="text-muted small mt-2">Camera ch∆∞a b·∫Øt</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation buttons -->
            <div class="d-flex justify-content-between mt-3" id="nav-buttons" style="display:none!important;">
                <button id="btn-prev" class="btn btn-outline-secondary" disabled>
                    <i class="fas fa-arrow-left me-1"></i>Tr∆∞·ªõc
                </button>
                <button id="btn-skip" class="btn btn-warning">
                    <i class="fas fa-forward me-1"></i>Skip
                </button>
            </div>

            <!-- Progress indicator -->
            <div class="text-center mt-3 text-muted small" id="progress-text"></div>

            <div class="text-center mt-3 gap-2 d-flex justify-content-center">
                <a href="{% url 'learn_alphabet' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Quay l·∫°i
                </a>
                <a href="{% url 'practice_camera' %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-camera me-1"></i>Luy·ªán T·∫≠p V·ªõi Camera
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let letterData = [];
let currentIndex = 0;

fetch('/api/letters/')
  .then(r => r.json())
  .then(data => {
    if (!data.success) {
      document.getElementById('letter-card-container').innerHTML = 
        '<div class="alert alert-danger">L·ªói: ' + (data.error || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu') + '</div>';
      return;
    }
    letterData = data.items || [];
    if (letterData.length === 0) {
      document.getElementById('letter-card-container').innerHTML = 
        '<div class="alert alert-info">Ch∆∞a c√≥ d·ªØ li·ªáu ch·ªØ c√°i</div>';
      return;
    }
    
    // Sort alphabetically
    letterData.sort((a, b) => a.name.localeCompare(b.name));
    
    document.getElementById('nav-buttons').style.display = 'flex';
    renderCard();
  })
  .catch(err => {
    console.error(err);
    document.getElementById('letter-card-container').innerHTML = 
      '<div class="alert alert-danger">L·ªói k·∫øt n·ªëi</div>';
  });

let cameraStream = null;
let recognitionInterval = null;
let cameraActive = false;
let correctCount = 0;
const CORRECT_THRESHOLD = 1; // Need 1 correct prediction to advance

// Speech synthesis
const speechSynth = window.speechSynthesis;
let isSpeaking = false;
let hasSpokenForCurrentCard = false; // Flag to speak only once per card

// Get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function speakLetter(letter) {
  if (isSpeaking) {
    speechSynth.cancel();
  }
  
  const utterance = new SpeechSynthesisUtterance(letter);
  utterance.rate = 0.8;
  utterance.pitch = 1;
  utterance.volume = 1;
  
  // Try Vietnamese voice
  const vietnameseVoice = speechSynth.getVoices().find(voice => 
    voice.lang.includes('vi') || voice.lang.includes('VN')
  );
  if (vietnameseVoice) {
    utterance.voice = vietnameseVoice;
    utterance.lang = 'vi-VN';
  } else {
    utterance.lang = 'en-US';
  }
  
  utterance.onstart = () => {
    isSpeaking = true;
    document.getElementById('camera-status').textContent = `ƒêang ph√°t √¢m: ${letter}`;
  };
  
  utterance.onend = () => {
    isSpeaking = false;
    document.getElementById('camera-status').textContent = `ƒê√£ ph√°t √¢m xong: ${letter}`;
    // Advance after speech ends
    advanceToNext();
  };
  
  speechSynth.speak(utterance);
}

function advanceToNext() {
  setTimeout(() => {
    if (currentIndex < letterData.length - 1) {
      currentIndex++;
      renderCard();
      console.log('Advanced to next letter after speech and delay');
    } else {
      document.getElementById('camera-status').textContent = 'ƒê√£ ho√†n th√†nh t·∫•t c·∫£ ch·ªØ c√°i! üéâ';
    }
  }, 3000); // 3 second delay
}

function renderCard() {
  if (letterData.length === 0) return;
  
  const item = letterData[currentIndex];
  const container = document.getElementById('letter-card-container');
  correctCount = 0; // Reset count on new card
  hasSpokenForCurrentCard = false; // Reset speech flag
  
  container.innerHTML = `
    <div class="card shadow-lg rounded-3" style="height: 468px; overflow: hidden;">
      <div class="card-body p-3 d-flex align-items-center justify-content-center" style="height: 100%; background: #f8f9fa;">
        <img src="${item.url}" class="img-fluid" alt="${item.name}" 
             style="max-height: 100%; max-width: 100%; object-fit: contain;">
      </div>
    </div>
  `;
  
  // Update buttons
  document.getElementById('btn-prev').disabled = currentIndex === 0;
  
  // Update progress
  document.getElementById('progress-text').textContent = 
    `Ch·ªØ c√°i ${currentIndex + 1}/${letterData.length}`;
}

document.getElementById('btn-prev').addEventListener('click', () => {
  if (currentIndex > 0) {
    currentIndex--;
    renderCard();
  }
});

document.getElementById('btn-skip').addEventListener('click', () => {
  if (currentIndex < letterData.length - 1) {
    currentIndex++;
    renderCard();
  } else {
    currentIndex = 0;
    renderCard();
  }
});

// Camera controls
document.getElementById('btn-camera').addEventListener('click', async () => {
  if (!cameraActive) {
    await startCamera();
  } else {
    stopCamera();
  }
});

async function startCamera() {
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { width: 640, height: 480 } 
    });
    document.getElementById('video').srcObject = cameraStream;
    cameraActive = true;
    document.getElementById('btn-camera').innerHTML = '<i class="fas fa-stop me-1"></i>T·∫Øt Camera';
    document.getElementById('camera-status').textContent = 'Camera ƒëang ho·∫°t ƒë·ªông';
    
    // Start recognition
    startRecognition();
  } catch (err) {
    console.error('Camera error:', err);
    document.getElementById('camera-status').textContent = 'L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p camera';
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  if (recognitionInterval) {
    clearInterval(recognitionInterval);
    recognitionInterval = null;
  }
  cameraActive = false;
  document.getElementById('btn-camera').innerHTML = '<i class="fas fa-camera me-1"></i>B·∫≠t Camera';
  document.getElementById('camera-status').textContent = 'Camera ƒë√£ t·∫Øt';
  document.getElementById('video').srcObject = null;
}

function startRecognition() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  
  recognitionInterval = setInterval(async () => {
    if (!cameraActive || letterData.length === 0) return;
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    const targetLetter = letterData[currentIndex].name;
    
    try {
      const response = await fetch('/api/recognize/', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ image: imageData, mode: 'letters' })
      });
      
      const data = await response.json();
      console.log('Recognition response:', data);
      // N·∫øu server b√°o kh√¥ng ph√°t hi·ªán tay th√¨ kh√¥ng so s√°nh v√† hi·ªán tr·∫°ng th√°i
      if (data && data.hand_detected === false) {
        document.getElementById('camera-status').textContent = 'Kh√¥ng ph√°t hi·ªán b√†n tay';
        return;
      }
      if (data.success && data.prediction) {
        const predicted = String(data.prediction).trim().toUpperCase();
        const target = targetLetter.trim().toUpperCase();
        console.log(`Comparing: "${predicted}" === "${target}" => ${predicted === target}`);
        document.getElementById('camera-status').textContent = `Nh·∫≠n di·ªán: ${predicted} (C·∫ßn: ${target})`;
        
        if (predicted === target) {
          let canPass = false;
          if (target === 'E') {
            canPass = data.hand_detected && data.confidence >= 0.9;
            console.log(`E check: hand_detected=${data.hand_detected}, confidence=${data.confidence * 100}%`);
          } else {
            canPass = data.confidence >= 0.3;
          }
          
          if (canPass && !hasSpokenForCurrentCard) {
            console.log(`‚úÖ MATCH for ${target}! Speaking once and then advancing...`);
            hasSpokenForCurrentCard = true;
            showSuccess();
            speakLetter(target);
          } else if (canPass && hasSpokenForCurrentCard) {
            console.log(`‚úÖ Already spoken for ${target}, waiting for advance...`);
          } else {
            console.log(`‚ùå Cannot pass ${target}. Hand detected: ${data.hand_detected}, Confidence: ${data.confidence * 100}%`);
          }
        } else {
          console.log('‚ùå No match');
        }
      }
    } catch (err) {
      console.error('Recognition error:', err);
    }
  }, 1000);
}

function showSuccess() {
  const indicator = document.getElementById('success-indicator');
  indicator.style.display = 'block';
  setTimeout(() => {
    indicator.style.display = 'none';
  }, 1500);
}
</script>
{% endblock %}